name: Update README with Detailed Activity
on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Fetch & Render Detailed Activity
        id: render
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username    = 'PhungVietBac';
            const maxRepos    = 6;
            const eventsPerRepo = 5;
            const { data: repos } = await github.rest.repos.listForUser({
              username, sort: 'updated', per_page: maxRepos
            });

            let md = '\n';
            for (const repo of repos) {
              md += `## [${repo.name}](${repo.html_url})\n\n`;

              const { data: events } = await github.rest.activity.listRepoEvents({
                owner: username,
                repo: repo.name,
                per_page: eventsPerRepo
              });
              if (!events.length) {
                md += `- _No recent events_\n\n`;
                continue;
              }

              for (const ev of events) {
                const when = new Date(ev.created_at)
                  .toLocaleString('en-GB',{ timeZone:'Asia/Ho_Chi_Minh' });

                switch (ev.type) {
                  case 'PushEvent': {
                    const commits = ev.payload.commits || [];
                    md += `- **PushEvent**: ${commits.length} commit(s) by **${ev.actor.login}** at ${when}\n`;
                    for (const c of commits) {
                      const sha7 = c.sha.slice(0,7);
                      const commitUrl = `${repo.html_url}/commit/${c.sha}`;
                      md += `  - [\`${sha7}\`]( ${commitUrl} ): ${c.message} _(by ${c.author.name})_\n`;
                    }
                    break;
                  }
                  case 'PullRequestEvent': {
                    const pr = ev.payload.pull_request;
                    md += `- **PullRequestEvent**: [#${pr.number} ${pr.title}](${pr.html_url}) by **${ev.actor.login}** (${pr.state}${pr.merged? ', merged':'')}) at ${when}\n`;
                    break;
                  }
                  case 'IssuesEvent': {
                    const issue = ev.payload.issue;
                    md += `- **IssuesEvent**: [#${issue.number} ${issue.title}](${issue.html_url}) by **${ev.actor.login}** (${issue.state}) at ${when}\n`;
                    break;
                  }
                  case 'IssueCommentEvent': {
                    const issue = ev.payload.issue;
                    const comment = ev.payload.comment.body.split('\n')[0];
                    md += `- **IssueCommentEvent** on [#${issue.number} ${issue.title}](${issue.html_url}) by **${ev.actor.login}**: "${comment}" at ${when}\n`;
                    break;
                  }
                  case 'ReleaseEvent': {
                    const rel = ev.payload.release;
                    md += `- **ReleaseEvent**: [${rel.name || rel.tag_name}](${rel.html_url}) (${rel.tag_name}) by **${ev.actor.login}** at ${when}\n`;
                    break;
                  }
                  default:
                    md += `- **${ev.type}** by **${ev.actor.login}** at ${when} ([repo](${repo.html_url}))\n`;
                }
              }

              md += `\n`;
            }

            return md;

      - name: Inject into README.md
        run: |
          sed -i '/<!-- START_SECTION:activity -->/,/<!-- END_SECTION:activity -->/c\
          <!-- START_SECTION:activity -->\
          $(steps.render.outputs.result)\
          <!-- END_SECTION:activity -->' README.md

      - name: Commit & Push if changed
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --exit-code; then
            echo "✅ No changes to commit"
          else
            git commit -m "⚡ Update README with detailed activity"
            git push origin HEAD:${{ github.ref_name }}
          fi
